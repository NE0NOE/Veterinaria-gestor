# Nombre del workflow, aparecerÃ¡ en la pestaÃ±a "Actions"
name: Deploy to EC2 on Push

# Disparador: se ejecuta cada vez que hay un push a la rama 'main'
on:
  push:
    branches:
      - main

# Trabajos que se van a ejecutar
jobs:
  deploy:
    # El tipo de mÃ¡quina virtual donde se ejecutarÃ¡ el workflow
    runs-on: ubuntu-latest

    # Pasos que componen el trabajo de despliegue
    steps:
      # Paso 1: Configurar la llave SSH para poder acceder a la EC2
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.EC2_SSH_KEY }}
          known_hosts: 'just-a-placeholder'

      # Paso 2: AÃ±adir la huella digital del servidor EC2 para evitar preguntas interactivas
      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # Paso 3: Conectarse a la EC2 y ejecutar los comandos de despliegue
      - name: Deploy to EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            # Navega a la carpeta del proyecto
            cd ${{ secrets.PROJECT_PATH }}
            echo "âœ… NaveguÃ© a $(pwd)"

            # Descarga los Ãºltimos cambios desde GitHub
            git pull origin main
            echo "âœ… CÃ³digo actualizado desde GitHub."

            # Instala/actualiza las dependencias de Node.js
            npm install
            echo "âœ… Dependencias instaladas."

            # Compila la aplicaciÃ³n para producciÃ³n
            npm run build
            echo "âœ… Proyecto compilado con 'npm run build'."

            # Reinicia la aplicaciÃ³n usando PM2
            pm2 restart veterinaria-app
            echo "âœ… AplicaciÃ³n reiniciada con PM2."
            
            echo "ðŸš€ Despliegue completado."
          EOF